const x=(t,e)=>e.some(n=>t instanceof n);let C,q;function N(){return C||(C=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function R(){return q||(q=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const b=new WeakMap,m=new WeakMap,h=new WeakMap;function k(t){const e=new Promise((n,a)=>{const r=()=>{t.removeEventListener("success",o),t.removeEventListener("error",i)},o=()=>{n(f(t.result)),r()},i=()=>{a(t.error),r()};t.addEventListener("success",o),t.addEventListener("error",i)});return h.set(e,t),e}function O(t){if(b.has(t))return;const e=new Promise((n,a)=>{const r=()=>{t.removeEventListener("complete",o),t.removeEventListener("error",i),t.removeEventListener("abort",i)},o=()=>{n(),r()},i=()=>{a(t.error||new DOMException("AbortError","AbortError")),r()};t.addEventListener("complete",o),t.addEventListener("error",i),t.addEventListener("abort",i)});b.set(t,e)}let P={get(t,e,n){if(t instanceof IDBTransaction){if(e==="done")return b.get(t);if(e==="store")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return f(t[e])},set(t,e,n){return t[e]=n,!0},has(t,e){return t instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in t}};function F(t){P=t(P)}function W(t){return R().includes(t)?function(...e){return t.apply(D(this),e),f(this.request)}:function(...e){return f(t.apply(D(this),e))}}function T(t){return typeof t=="function"?W(t):(t instanceof IDBTransaction&&O(t),x(t,N())?new Proxy(t,P):t)}function f(t){if(t instanceof IDBRequest)return k(t);if(m.has(t))return m.get(t);const e=T(t);return e!==t&&(m.set(t,e),h.set(e,t)),e}const D=t=>h.get(t);function V(t,e,{blocked:n,upgrade:a,blocking:r,terminated:o}={}){const i=indexedDB.open(t,e),c=f(i);return a&&i.addEventListener("upgradeneeded",s=>{a(f(i.result),s.oldVersion,s.newVersion,f(i.transaction),s)}),n&&i.addEventListener("blocked",s=>n(s.oldVersion,s.newVersion,s)),c.then(s=>{o&&s.addEventListener("close",()=>o()),r&&s.addEventListener("versionchange",d=>r(d.oldVersion,d.newVersion,d))}).catch(()=>{}),c}const $=["get","getKey","getAll","getAllKeys","count"],K=["put","add","delete","clear"],I=new Map;function M(t,e){if(!(t instanceof IDBDatabase&&!(e in t)&&typeof e=="string"))return;if(I.get(e))return I.get(e);const n=e.replace(/FromIndex$/,""),a=e!==n,r=K.includes(n);if(!(n in(a?IDBIndex:IDBObjectStore).prototype)||!(r||$.includes(n)))return;const o=async function(i,...c){const s=this.transaction(i,r?"readwrite":"readonly");let d=s.store;return a&&(d=d.index(c.shift())),(await Promise.all([d[n](...c),r&&s.done]))[0]};return I.set(e,o),o}F(t=>({...t,get:(e,n,a)=>M(e,n)||t.get(e,n,a),has:(e,n)=>!!M(e,n)||t.has(e,n)}));const G=["continue","continuePrimaryKey","advance"],A={},B=new WeakMap,v=new WeakMap,U={get(t,e){if(!G.includes(e))return t[e];let n=A[e];return n||(n=A[e]=function(...a){B.set(this,v.get(this)[e](...a))}),n}};async function*J(...t){let e=this;if(e instanceof IDBCursor||(e=await e.openCursor(...t)),!e)return;e=e;const n=new Proxy(e,U);for(v.set(n,e),h.set(n,D(e));e;)yield n,e=await(B.get(n)||e.continue()),B.delete(n)}function S(t,e){return e===Symbol.asyncIterator&&x(t,[IDBIndex,IDBObjectStore,IDBCursor])||e==="iterate"&&x(t,[IDBIndex,IDBObjectStore])}F(t=>({...t,get(e,n,a){return S(e,n)?J:t.get(e,n,a)},has(e,n){return S(e,n)||t.has(e,n)}}));function z(t){if(!t.objectStoreNames.contains("participantBatch")){const e=t.createObjectStore("participantBatch",{keyPath:"id",autoIncrement:!0});e.createIndex("raffle_week_code","raffle_week_code",{unique:!1}),e.createIndex("date_start","date_start",{unique:!1}),e.createIndex("date_end","date_end",{unique:!1}),e.createIndex("raffle_date_time_started","raffle_date_time_started",{unique:!1}),e.createIndex("raffle_date_time_ended","raffle_date_time_ended",{unique:!1}),e.createIndex("is_completed","is_completed",{unique:!1}),e.createIndex("drawn_by_user_id","drawn_by_user_id",{unique:!1}),console.log("participantBatch store created ✅")}}function H(t){if(!t.objectStoreNames.contains("participant")){const e=t.createObjectStore("participant",{keyPath:"id",autoIncrement:!0});e.createIndex("is_drawn","is_drawn",{unique:!1}),e.createIndex("is_archived","is_archived",{unique:!1}),e.createIndex("id_entry","id_entry",{unique:!1}),e.createIndex("raffle_code","raffle_code",{unique:!1}),e.createIndex("regional_location","regional_location",{unique:!1}),e.createIndex("participant_batch_id","participant_batch_id",{unique:!1}),e.createIndex("region_drawn",["regional_location","is_drawn"],{unique:!1}),e.createIndex("entry_drawn",["id_entry","is_drawn"],{unique:!1}),console.log("participant store created ✅")}}function Q(t){if(!t.objectStoreNames.contains("winnerParticipant")){const e=t.createObjectStore("winnerParticipant",{keyPath:"id",autoIncrement:!0});e.createIndex("raffle_code","raffle_code",{unique:!1}),e.createIndex("id_entry","id_entry",{unique:!1}),e.createIndex("is_proclaimed","is_proclaimed",{unique:!1}),e.createIndex("draw_date","draw_date",{unique:!1}),e.createIndex("won_at","won_at",{unique:!1}),e.createIndex("winner_type","winner_type",{unique:!1}),e.createIndex("participant_id","participant_id",{unique:!1}),e.createIndex("participant_batch_id","participant_batch_id",{unique:!1}),e.createIndex("winner_type_draw_date",["winner_type","draw_date"],{unique:!1}),console.log("winnerParticipant store created ✅")}}function X(t){let e=t.replace(/\d+/g,"");e=e.replace(/([.;])/g,"$1 ").replace(/\s+/g," ").trim(),e=e.replace(/Ñ/g,"6").replace(/ñ/g,"9").toLowerCase();const n=["Para makumpleto ang iyong registration, ibigay ang mga sumusunod na information. Ano ang inyong Full Name?","Example: Juan B. Dela Cruz","first name","Example","example","N/A","n/a","middle name","middle initial","last name","full name","middle","none","name"];for(const r of n)e=e.replace(r.toLowerCase(),"");e=e.replace(/[^\w\s.-]/g,""),e=e.replace(/\s\.\s/g," "),e=e.replace(/\b([a-z])\b/g,"$1.");let a="";return e=e.replace(/\b(jr|sr|iii|lll)\b/gi,r=>(a+=` ${r}`,"")).trim(),e=e.replace(/\.{2,}/g,".").replace(/\s\.\s/g," "),e=e.replace(/(\.\b\w{2,})|(\b\w{2,}\.)/g,r=>r.replace(/\./g,"")),e=e.replace(/\s\.\s/g," "),a&&(a=a.split(" ").filter(Boolean).map(r=>r.replace(/\b(jr|sr|iii|lll)\b/gi,o=>o.endsWith(".")?o:o+".")).join(" "),e+=" "+a),e=e.split(" ").map(r=>r.charAt(0).toUpperCase()+r.slice(1).toLowerCase()).join(" "),e=e.replace(/6/g,"Ñ").replace(/9/g,"ñ"),e.trim()}function Y(t){if(!t.objectStoreNames.contains("syncCloud")){const e=t.createObjectStore("syncCloud",{keyPath:"id",autoIncrement:!0});e.createIndex("status","status",{unique:!1}),e.createIndex("type","type",{unique:!1}),e.createIndex("createdAt","createdAt",{unique:!1}),e.createIndex("status_createdAt",["status","createdAt"],{unique:!1}),e.createIndex("type_createdAt",["type","createdAt"],{unique:!1}),console.log("syncCloud store created ✅")}}const Z="RaffleDrawDB",j=18;let _=null;function l(){return _||(_=V(Z,j,{upgrade(t){console.log("Running onupgradeneeded for DB version:",j),z(t),H(t),Q(t),Y(t)}}),_)}async function ie(t,e){return(await l()).add(t,e)}async function se(t,e,n){const r=(await l()).transaction(t,"readwrite"),o=r.store,i=await o.count();let c=0,s=await o.openCursor();for(;s;){for(let d=0;d<e&&s;d++)await s.delete(),c++,s=await s.continue();n(c,i)}await r.done}async function ce(t){const e=await l(),n="participant",a=1e3,r=await e.count(n),o=new Map;let i=0,c=null,s=null;return new Promise(async(d,y)=>{try{let w=await e.transaction(n,"readonly").objectStore(n).openCursor();for(;w;){const u=w.value,g=u.regional_location;if(g&&o.set(g,(o.get(g)||0)+1),u.registered_at){const p=new Date(u.registered_at).getTime();(!c||p<c)&&(c=p),(!s||p>s)&&(s=p)}if(i++,i%a===0){const p=Math.min(parseFloat((i/r*100).toFixed(2)),100);t(p)}w=await w.continue()}t(Math.min(parseFloat((i/r*100).toFixed(2)),100));let E=0;if(c&&s&&s>c){const u=Math.max(1,Math.ceil((s-c)/864e5));E=parseFloat((r/u).toFixed(2))}const L=Array.from(o.entries()).map(([u,g])=>({location:u,count:g}));d({totalParticipants:r,dailyAverage:E,regions:L})}catch{y("Failed during location counting.")}})}async function de(t,e,n){console.log("Page No: ",e),console.log("Number of rows per page: ",n);const r=(await l()).transaction("participant","readonly").objectStore("participant"),o=await r.openCursor();if(!o)return[];const i=o.key,c=(e-1)*n,s=i+c,d=i+c+n-1;try{return await r.getAll(IDBKeyRange.bound(s,d))}catch(y){throw console.error("Error fetching participants for page:",y),console.log("PAGE: ",e," RANGE: ",n),new Error("Failed to retrieve participants for page.")}}async function le(t){console.log("Getting winners with type:",t,"...");const e=await l(),n="winnerParticipant",a=[];try{const i=e.transaction(n,"readonly").objectStore(n).index("winner_type_draw_date"),c=IDBKeyRange.bound([t,""],[t,"￿"]);let s=await i.openCursor(c,"prev");for(;s;)a.push(s.value),s=await s.continue();return a}catch(r){throw console.error("Error fetching winners for page:",r),new Error("Failed to retrieve winners for page.")}}async function ue(){return await(await l()).count("participant")>0}async function ee(){return await(await l()).count("participant")-1}async function fe(t){return await(await l()).transaction("winnerParticipant","readonly").objectStore("winnerParticipant").index("winner_type").count(IDBKeyRange.only(t))>0}function te(t,e){return console.log("Total Matches for specified region: ",e),console.log("Choosing from ",t," to ",e),Math.floor(Math.random()*(e-t))+t}async function ne(t){console.log("Getting participants by region: ",t);const a=(await l()).transaction("participant","readonly").objectStore("participant"),r=[];console.log("Filtering by region AND is_drawn true");const o=a.index("region_drawn"),i=IDBKeyRange.only([t,"false"]);let c=await o.openCursor(i);for(;c;)r.push(c.value),c=await c.continue();return r}const re=async()=>await(await l()).transaction("participant","readonly").objectStore("participant").index("is_drawn").get("false")??null;async function ae(){const a=await(await l()).transaction("participant","readonly").objectStore("participant").openCursor();return a?(console.log("Getting first participant as starting point:",a.value),a.value.id_entry??null):null}async function oe(t){return await(await l()).transaction("participant","readonly").objectStore("participant").index("entry_drawn").get([t,"false"])??null}async function pe(t){console.log(t?`Favorable Region Set: ${t}`:"No favorable region set");let e=null;if(t){const n=await ne(t);if(n.length===0)throw new Error(`No participants found in region: ${t}`);for(;!e;){const a=Math.floor(Math.random()*n.length);e=n[a]||null,e||console.log(`Participant not found at index: ${a}, retrying...`)}}else{const n=await ee();if(!n||n===0)throw new Error("No participants available.");let a=null,r=0;const o=await ae();for(;!e&&r<5&&o;){const i=te(Number(o),n+Number(o)).toString();e=await oe(i),e||(console.log(`Participant not found with ID entry: ${i}, retrying...`),r++)}if(!e&&(console.log("Max retries reached. Calling lastResort()..."),e=await re(),!e))throw new Error(`Participant not found with ID entry: ${a}`)}return e={...e,full_name_raw:e.full_name,full_name:X(e.full_name)},e}export{ce as a,le as b,ie as c,se as d,ue as e,de as g,fe as h,l as i,pe as p};
